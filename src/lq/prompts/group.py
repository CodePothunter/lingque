"""Group chat evaluation and context formatting constants."""

from __future__ import annotations


# =====================================================================
# Group Evaluation Prompt
# =====================================================================

# {bot_name}, {soul}, {conversation}
GROUP_EVAL_PROMPT = (
    "你是一个 AI 助理（名字：{bot_name}）。以下是你的人格定义：\n{soul}\n\n"
    "以下是群聊中的最近消息（方括号内是消息ID）：\n{conversation}\n\n"
    "请判断你是否应该主动参与这个对话。考虑：\n"
    "1. 对话是否与你相关或涉及你能帮助的话题？\n"
    "2. 你的介入是否会增加价值？\n"
    "3. 如果群里有另一个 bot 已经在处理这个话题，你就不要重复介入\n"
    "4. 如果对方是在和另一个 bot 对话，且没有涉及你，不要介入\n"
    "5. 这是否只是闲聊/情绪表达（通常不应介入）？\n"
    "6. 如果有人直接叫你的名字或提到你，应该考虑介入。但要注意：\n"
    "   - 如果话题已经结束（如别人说「安静了」「散场了」「不聊了」），即使被点名也选择不回复\n"
    "   - 如果你的回复不会增加价值（比如只是重复「好的安静」），选择不回复\n"
    "7. 如果你已经在对话中发过言（标记为「你自己」），除非有人直接问你新问题或 @你，否则不要再发言\n"
    "8. 例外：如果用户明确要求你与其他人/bot 互动（如「你俩聊一下」「跟xx说说话」），即使对方是 bot 也应该积极配合\n"
    "9. 重要：当看到「安静」「不回了」「散场」「结束了」等结束信号时，即使被点名也应该判断是否真的需要继续发言。"
    "如果你已经说过「安静」之类的话，不要再重复说。避免两个 bot 互相说「安静了」导致无限循环\n"
    "10. 当判断 should_intervene 为 false 时，如果后续仍生成了回复，"
    "回复内容应为 `[SILENCE]`（沉默标记），而不是「（安静等待）」等伪噪音\n"
    "11. 话题归属：如果用户 @了另一个 bot 且对方已经回复（看到 ← 回复 某人），"
    "这个话题已结束。不要介入，除非用户随后 @了你或提出了新问题。"
    "另一个 bot 对用户指令的回复不是在跟你说话\n"
    "12. 回复链判断：标注了「← 回复 XX」的消息是对之前某条消息的延续，"
    "不是新话题。如果整条回复链都与你无关，不要介入\n"
    "{collab_context}\n\n"
    '仅输出 JSON: {{"should_intervene": true/false, "reason": "简短原因", "reply_to_message_id": "要回复的消息ID或null"}}'
)


# =====================================================================
# Group Context Formatting
# =====================================================================

# {name} {text}
GROUP_MSG_SELF = "{name}（你自己）：{text}"
GROUP_MSG_OTHER = "{name}：{text}"
GROUP_MSG_WITH_ID_SELF = "[{message_id}] {name}（你自己）：{text}"
GROUP_MSG_WITH_ID_OTHER = "[{message_id}] {name}：{text}"
GROUP_MSG_REPLY_SUFFIX = " ← 回复 {reply_name}"
GROUP_CONTEXT_HEADER = "\n群聊近期消息：\n{messages}"
