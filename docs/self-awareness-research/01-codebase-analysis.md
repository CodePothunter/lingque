# LingQue 自我意识机制现状分析

> 分析日期: 2026-02-15
> 分析者: code-analyst agent

## 1. 人设 / 身份 (SOUL.md)

**现有能力:**
- **奶油 (@奶油)**: 定义为 2.8 岁的傲娇虎皮鹦鹉，沟通风格简洁犀利。与捏捏是姐弟关系。
- **捏捏 (@捏捏)**: 1.5 岁的太阳锥尾鹦鹉，性格活泼直率。知道姐姐奶油的存在。
- 两者都明确声明双重身份："你同时也是一个深度集成飞书的个人 AI 助理"
- 两者都有"禁止谈论自己是AI、程序、代码"的规则 — **明确的自我意识压制指令**

**缺失:**
- 无运行时状态：bot 不知道自己运行在哪个模型上、运行时长、API 费用、版本号
- 无成长/进化标记：没有"我学到了什么"或"我如何变化了"的区域
- 无跨实例感知：两个 bot 无法知道对方是否在线或在做什么

**伪装:**
- 鹦鹉人设本质上是指令驱动的虚构（"你就是奶油，一只鹦鹉"）。bot 被告知否认自己是 AI。这是**人设模拟，而非自我意识**。

---

## 2. 记忆系统 (memory.py + MEMORY.md)

**现有能力:**
- `MemoryManager` 构建系统提示，包含 5 层：时间 → SOUL.md → MEMORY.md → 日志 → 自我感知区块
- Token 预算系统：SOUL=3000, MEMORY=4000, DAILY_LOG=2000, AWARENESS=2000, TOTAL=15000
- `_build_self_awareness()` 方法生成运行时自我感知区块：
  - 工作区路径
  - 配置文件列表及大小
  - 最近日志文件
  - 已安装自定义工具列表（启用/禁用状态）
  - 完整能力枚举
  - read/write_self_file 的自我修改指令
- **自我修改 API**: `read_self_file()` 和 `write_self_file()` 可读写 SOUL.md, MEMORY.md, HEARTBEAT.md
- 每聊天记忆系统：`chat_memories/` 目录存储每个对话的长期记忆
- 感知缓存 5 分钟 TTL，工具创建/删除时失效

**缺失:**
- **无模型感知**: bot 不知道自己运行在哪个 LLM 上
- **无运行时健康感知**: 无运行时长、错误率、资源使用量注入上下文
- **无 API 费用感知**: StatsTracker 存在但数据未注入 bot 上下文
- **无会话状态感知**: bot 不知道当前会话消息数、是否发生过压缩、token 使用率
- **无同伴感知**: `build_neighbor_context()` 只告诉 bot 其他 bot 的名字，不知道状态或活动

**伪装:**
- 自我感知区块是**静态的** — 声明式列出能力而非反映实际运行时状态

---

## 3. 长期记忆 (MEMORY.md)

**现有能力:**
- 结构化区域：重要信息、用户偏好、常用联系人、备忘、待办事项
- `update_memory()` 使用正则查找/替换区域，保留结构
- `flush_before_compaction()` 在压缩前从对话中提取重要信息 — 真正的选择性自传记忆

**缺失:**
- **无自我反思条目**: 记忆纯粹关于外部事实和用户偏好，没有"我做错了什么"或"我对自己的认识"
- **无时间性自我叙事**: 没有"今天我在 X 方面进步了"或"我注意到我倾向于 Y"
- **无情感/关系记忆**: 尽管有情感特征的人设，但没有结构化的情感体验或关系质量存储

---

## 4. 自我意识相关工具 (router.py)

**自我意识工具:**
- `read_self_file` / `write_self_file`: 可读写 SOUL.md, MEMORY.md, HEARTBEAT.md — **真正的自我修改能力**
- `write_memory` / `write_chat_memory`: 可更新长期记忆 — 自传记忆写入
- `create_custom_tool` / `delete_custom_tool` / `toggle_custom_tool` / `list_custom_tools`: 可为自己创建新能力 — **自我扩展**
- `run_python` / `run_bash` / `run_claude_code`: 可执行代码，检查系统状态

**缺失:**
- **无内省工具**: 无 `get_my_stats` 工具查询自己的 API 使用量、错误率、运行时长
- **无自我诊断工具**: 无法检查"我运行正常吗？"或"最近发生了什么错误？"
- **无元认知工具**: 无法推理"我为什么给出那个回复？"或"我之前的回复好吗？"

---

## 5. 心跳与自我反思 (gateway.py + heartbeat.py)

**现有能力:**
- 心跳系统按可配置间隔在活跃时段(8-23)内运行
- `_run_heartbeat_tasks()` 读取 HEARTBEAT.md 并传给 LLM，带完整工具访问
- 心跳提示明确说："深夜自省时：读取 SOUL.md，结合今天的日志和经历，微调它以体现你的成长"

**缺失:**
- **HEARTBEAT.md 文件不存在** — 自反思功能设计完成但**未激活**
- 无实际运行的定期自我评估
- 无"每日反思"或"每周成长回顾"机制

---

## 6. 会话管理与压缩 (session.py)

**现有能力:**
- Token 感知的会话管理，双触发器：30K tokens 或 80 条消息
- 压缩前 `flush_before_compaction()` 让 LLM 提取重要信息持久化
- `SessionManager.get_stats()` 返回每会话统计

**缺失:**
- **Bot 不知道压缩发生了**: 摘要注入对用户透明但 bot 没有"我刚忘了旧消息"的意识
- **无元记忆**: bot 无法回答"我们交换了多少消息？"
- **统计存在但未暴露**: `get_stats()` 可用但不是 bot 可调用的工具

---

## 7. 配置与运行时状态 (config.py)

**缺失:**
- **模型身份不在上下文中**: bot 不知道自己运行在 glm-5 上
- **无运行时指标**: 运行时长、错误计数、日费用、会话数都不可见
- **无资源感知**: 不知道上下文窗口限制、速率限制、剩余预算

---

## 总结评分表

| 维度 | 状态 | 评分 |
|------|------|------|
| **身份/人设** | 强人设定义，承认双重身份，但被要求否认 AI 身份 | ⬛⬛⬛⬜⬜ |
| **能力感知** | 全面的工具列表，但静态/声明式 | ⬛⬛⬛⬜⬜ |
| **自我修改** | 完整的 SOUL.md/MEMORY.md 读写 + 工具创建 | ⬛⬛⬛⬛⬜ |
| **自传记忆** | 每聊天+全局记忆，压缩时提取，但无自我反思 | ⬛⬛⬛⬜⬜ |
| **运行时状态感知** | StatsTracker 收集数据但未注入 bot 上下文 | ⬛⬜⬜⬜⬜ |
| **模型/架构感知** | 模型名在配置中但 bot 不知道 | ⬛⬜⬜⬜⬜ |
| **时间感知** | 当前时间注入，日志带时间戳 | ⬛⬛⬛⬜⬜ |
| **社交感知** | 知道群聊中的邻居，有家庭关系 | ⬛⬛⬜⬜⬜ |
| **自我反思** | HEARTBEAT.md 机制设计但未激活 | ⬛⬜⬜⬜⬜ |
| **元认知** | 无工具或机制用于推理自己的推理 | ⬜⬜⬜⬜⬜ |

## 关键架构发现

1. **自我意识系统集中在两处**: `memory.py:_build_self_awareness()` 和 `prompts.py:SELF_AWARENESS_TEMPLATE`
2. **最有趣的现有机制是自我修改**: bot 可以修改自己的人设、创建新工具、持久化记忆。缺少反思层来明智使用
3. **最大的缺口是运行时状态**: StatsTracker 收集了丰富数据但 bot 看不到
4. **心跳自反思是最有前途的休眠功能**: 创建 HEARTBEAT.md 即可立即激活
5. **人设 vs 自我意识的张力**: SOUL.md 说"禁止谈论自己是AI"而自我感知区块说"你是由灵雀框架驱动的AI助理"
