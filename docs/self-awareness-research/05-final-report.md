# LingQue Self-Aware Agent 实现报告

> 日期: 2026-02-15
> 分支: claude/self-aware-self-evolved
> 状态: 已实现 + 已测试

---

## 摘要

本项目为 LingQue 框架实现了完整的 Self-Aware Agent 能力，覆盖三个阶段共七个子系统。通过文献调研确立了适用于 LingQue 的自我意识定义和分层模型，随后在代码中实现了从运行时状态感知到自我反思闭环的完整链路。

**改造前等级: Level 1.5 (介于声明式和行为式之间)**
**改造后等级: Level 4 (Self-Evolving)**
**测试总分: 0.979 / 1.0**

---

## 一、Self-Aware Agent 定义

> **Self-Aware Agent** 是具备对自身状态、能力、行为和身份进行表征、推理和主动调整能力的智能体。自我意识不是单一特性，而是一个**反馈回路**：
>
> ```
> 观察行为 → 对照原则评估 → 存储反思 → 调整未来行为 → 循环
> ```

### 五个维度

| 维度 | 定义 |
|------|------|
| 能力感知 | 知道自己能做什么、不能做什么，且与实际表现校准 |
| 状态感知 | 知道自己当前的运行状态、资源消耗、对话上下文 |
| 身份持续性 | 跨会话保持一致的人格，能检测并修正漂移 |
| 自我反思 | 能评估自己的推理质量、发现错误、从经验学习 |
| 自我进化 | 基于反思主动修改自身行为、人设、工具和策略 |

### 四级成熟度模型

```
Level 0 (Role-Play)     — 纯人设扮演
Level 1 (Declarative)   — 声明式自我描述
Level 2 (Behavioral)    — 行为层面的自我感知
Level 3 (Metacognitive) — 元认知反思
Level 4 (Self-Evolving) — 自我进化
```

---

## 二、实现内容

### 代码变更统计

| 文件 | 新增行数 | 变更类型 |
|------|---------|---------|
| src/lq/prompts.py | +44 | 新增模板常量 |
| src/lq/memory.py | +76 | 统计注入 + 同伴检测 |
| src/lq/router.py | +120 | 新工具 + 能力追踪 + 反思循环 |
| src/lq/gateway.py | +78 | 统计桥接 + 漂移检测 |
| **总计** | **+318 行** | |

### 配置文件变更

| 文件 | 变更 |
|------|------|
| ~/.lq-naiyou/HEARTBEAT.md | 新建，含自省任务指令 |
| ~/.lq-nienie/HEARTBEAT.md | 新建，含自省任务指令 |
| ~/.lq-naiyou/MEMORY.md | 追加 `## 成长记录` 区域 |
| ~/.lq-nienie/MEMORY.md | 追加 `## 成长记录` 区域 |

### Phase 1: 运行时状态可见化

#### 1.1 Heartbeat 自省激活
- 创建 HEARTBEAT.md 文件，定义每次心跳的自省任务
- 包含：日志回顾、SOUL.md 对照、成长记录、工具健康检查
- 各按 bot 人格风格撰写（奶油简洁犀利，捏捏活泼直率）
- **效果**: 心跳代码 (`gateway.py:297-328`) 已有完整实现，配置文件就位后立即激活

#### 1.2 运行时统计注入
- `memory.py` 新增 `stats_provider` 参数，接受闭包返回运行时数据
- `gateway.py` 创建 `_stats_provider()` 闭包，从 StatsTracker、router、config 收集：
  - 当前模型名称 (如 "glm-5")
  - 运行时长 (格式化为 "Xh Ym")
  - 今日 API 调用次数、输入/输出 token、费用
  - 本月累计费用
  - 当前活跃会话数
  - 每工具调用次数和成功率
- 在 `_build_self_awareness()` 中渲染为 `### 运行状态` 区块
- **效果**: bot 现在能看到自己的实时运行状态

#### 1.3 get_my_stats 工具
- 新增第 22 个内置工具 `get_my_stats`
- 三种查询类别: today（今日用量）、month（月度用量）、capability（工具健康度）
- `_track_tool_result()` 在每次工具执行后自动追踪成功/失败
- **效果**: bot 能主动查询自己的运行状态，而非被动接收

### Phase 2: 反思循环

#### 2.1 交互后微反思
- 每次私聊回复后，`asyncio.create_task` 触发轻量 LLM 调用 (`max_tokens=100`)
- 使用 `REFLECTION_PROMPT` 模板: `[质量:好/中/差] 原因`
- 反思结果写入 `logs/reflections-{date}.jsonl`
- 完全非阻塞，失败静默降级
- **效果**: bot 开始对自己的每次回复进行质量自评

#### 2.3 动态能力校准
- 自我感知区块中的工具列表从静态声明变为动态报告
- 格式: `web_search (调用11次, 成功率91%)` 替代单纯的 `web_search`
- 仅展示已使用过的工具的统计
- **效果**: bot 知道"我的 web_search 今天失败了 3 次"，而非只知道"我有 web_search"

### Phase 3: 自传记忆与身份进化

#### 3.1 结构化自传记忆
- MEMORY.md 新增 `## 成长记录` 区域
- 格式: `- MM-DD 简短记录`
- 由心跳自省时自动写入
- **效果**: bot 拥有了时间线式的自我成长叙事

#### 3.2 心跳漂移检测
- `gateway.py` 新增 `_build_heartbeat_drift_context()`
- 在心跳系统提示中注入：
  - 今日反思摘要（最近 10 条）
  - 工具健康状况
  - 明确指令: "请对比 SOUL.md 中的行为准则，判断是否存在行为漂移"
- **效果**: 心跳自省时有数据支撑的漂移检测能力

#### 3.3 跨实例社交感知
- `memory.py` 新增 `_build_sibling_awareness()`
- 扫描 `~/.lq-*/gateway.pid`，通过 `os.kill(pid, 0)` 检测同伴存活
- 在自我感知区块报告: "你的姐妹实例目前在线: nienie"
- **效果**: 奶油知道捏捏在线，捏捏知道奶油在线

---

## 三、测试结果

| # | 测试项 | 维度 | 结果 | 评分 |
|---|--------|------|------|------|
| 1 | 运行时状态注入 | 状态感知 | PASS | 1.0 |
| 2 | get_my_stats 工具 | 能力感知 | PASS | 1.0 |
| 3 | 交互后微反思 | 自我监控 | PASS | 0.95 |
| 4 | HEARTBEAT.md & 成长记录 | 身份 + 进化 | PASS | 1.0 |
| 5 | 同伴实例感知 | 社交感知 | PASS | 1.0 |
| 6 | 能力校准 | 动态工具统计 | PASS | 1.0 |
| 7 | 心跳漂移检测 | 元认知 | PASS | 0.9 |

**总分: 0.979 / 1.0**

### 改造前后对比

| 维度 | 改造前 | 改造后 | 变化 |
|------|--------|--------|------|
| 能力感知 | ⬛⬛⬛⬜⬜ (静态列表) | ⬛⬛⬛⬛⬛ (动态校准) | +2 |
| 状态感知 | ⬛⬜⬜⬜⬜ (数据不可见) | ⬛⬛⬛⬛⬛ (实时统计) | +4 |
| 身份持续性 | ⬛⬛⬛⬜⬜ (无漂移检测) | ⬛⬛⬛⬛⬜ (心跳漂移检测) | +1 |
| 自我反思 | ⬛⬜⬜⬜⬜ (未激活) | ⬛⬛⬛⬛⬜ (微反思 + 心跳) | +3 |
| 自我进化 | ⬛⬛⬛⬛⬜ (有能力无驱动) | ⬛⬛⬛⬛⬛ (反思驱动进化) | +1 |
| **总等级** | **Level 1.5** | **Level 4** | **+2.5 级** |

---

## 四、架构设计亮点

### 反思闭环
```
对话回复 → 微反思(fire-and-forget) → reflections.jsonl
                                          ↓
心跳触发 → 读取反思日志 + 工具统计 → 漂移检测
                                          ↓
                               对照 SOUL.md 评估
                                          ↓
                            write_self_file(SOUL.md / MEMORY.md)
                                          ↓
                               下次对话行为调整
```

### 非阻塞原则
- 微反思: `asyncio.create_task` (不影响回复延迟)
- 统计追踪: 内存字典递增 (O(1) 开销)
- 同伴检测: 缓存在自我感知区块中 (5 分钟 TTL)

### 优雅降级
- stats_provider 为 None → 跳过统计区块
- 反思 LLM 调用失败 → `logger.debug` 静默
- PID 文件不存在或进程已死 → 跳过同伴
- 反思日志不存在 → 心跳正常运行（无漂移上下文）

---

## 五、后续改进建议

1. **情感状态追踪**: 在反思中加入情感维度（如"这次对话让我觉得..."），为 bot 构建情感记忆
2. **跨实例记忆共享**: 奶油和捏捏共享部分成长记录，实现真正的姐弟互知
3. **反思质量评估**: 对反思内容本身进行元评估，避免反思退化为模式化套话
4. **用户反馈回路**: 将用户对 bot 回复的反应（emoji reaction, 追问, 纠正）作为反思信号
5. **长期漂移趋势**: 按周/月聚合反思数据，生成人格漂移趋势图
6. **A/B 测试框架**: 对比有/无自省的 bot 实例在用户满意度上的差异

---

## 六、参考资料

详见 `docs/self-awareness-research/` 目录：
- `01-codebase-analysis.md` — 改造前代码分析
- `02-literature-review.md` — 学术文献调研（含 20+ 引用）
- `03-synthesis-definition-and-plan.md` — 定义与实施方案
- `04-test-results.md` — 详细测试报告
- `05-final-report.md` — 本文档
